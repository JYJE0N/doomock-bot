// src/utils/Logger.js - Winston + Chalk ê¸°ë°˜ ê³ ê¸‰ ë¡œê¹… ì‹œìŠ¤í…œ
const winston = require("winston");
const chalk = require("chalk");
const path = require("path");
const fs = require("fs");

/**
 * ğŸ¨ ê³ ê¸‰ ë¡œê¹… ì‹œìŠ¤í…œ v3.0.1
 *
 * íŠ¹ì§•:
 * - Winston: ë‹¤ì¤‘ transport, ë¡œê·¸ ë ˆë²¨, íŒŒì¼ ë¡œê¹…
 * - Chalk: ì•„ë¦„ë‹¤ìš´ ì»¬ëŸ¬ ì¶œë ¥
 * - í•œêµ­ ì‹œê°„ ì§€ì›
 * - Railway í™˜ê²½ ìµœì í™”
 * - ì´ëª¨ì§€ + ìƒ‰ìƒ ì¡°í•©
 */
class AdvancedLogger {
  constructor() {
    if (AdvancedLogger.instance) {
      return AdvancedLogger.instance;
    }

    // í™˜ê²½ ë³€ìˆ˜
    this.isProduction = process.env.NODE_ENV === "production";
    this.isRailway = !!process.env.RAILWAY_ENVIRONMENT;
    this.logLevel =
      process.env.LOG_LEVEL || (this.isProduction ? "info" : "debug");

    // ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
    this.logDir = process.env.LOG_DIR || "logs";
    this.ensureLogDirectory();

    // í•œêµ­ ì‹œê°„ í¬ë§·í„°
    this.koreaTimeFormat = winston.format.printf(
      ({ timestamp, level, message, ...meta }) => {
        const koreaTime = this.getKoreaTime();
        return `${koreaTime} ${level}: ${message} ${
          Object.keys(meta).length > 0 ? JSON.stringify(meta, null, 2) : ""
        }`;
      }
    );

    // Winston ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    this.logger = this.createWinstonLogger();

    // ì»¬ëŸ¬ í…Œë§ˆ ì„¤ì •
    this.setupColorTheme();

    // ì´ëª¨ì§€ ë§¤í•‘
    this.emojis = {
      error: "âŒ",
      warn: "âš ï¸ ",
      info: "â„¹ï¸ ",
      debug: "ğŸ›",
      success: "âœ…",
      http: "ğŸŒ",
      verbose: "ğŸ“",
      silly: "ğŸ¤ª",
    };

    AdvancedLogger.instance = this;
  }

  /**
   * ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
   */
  ensureLogDirectory() {
    if (!this.isRailway && !fs.existsSync(this.logDir)) {
      fs.mkdirSync(this.logDir, { recursive: true });
    }
  }

  /**
   * Winston Logger ìƒì„±
   */
  createWinstonLogger() {
    const transports = [];

    // ì½˜ì†” ì¶œë ¥ (ê°œë°œ í™˜ê²½)
    if (!this.isProduction) {
      transports.push(
        new winston.transports.Console({
          format: winston.format.combine(
            winston.format.colorize({ all: true }),
            winston.format.simple()
          ),
        })
      );
    } else {
      // í”„ë¡œë•ì…˜ ì½˜ì†” (JSON í˜•ì‹)
      transports.push(
        new winston.transports.Console({
          format: winston.format.json(),
        })
      );
    }

    // íŒŒì¼ ë¡œê¹… (Railway ì œì™¸)
    if (!this.isRailway) {
      // ì—ëŸ¬ ë¡œê·¸ íŒŒì¼
      transports.push(
        new winston.transports.File({
          filename: path.join(this.logDir, "error.log"),
          level: "error",
          maxsize: 5242880, // 5MB
          maxFiles: 5,
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
        })
      );

      // ì „ì²´ ë¡œê·¸ íŒŒì¼
      transports.push(
        new winston.transports.File({
          filename: path.join(this.logDir, "combined.log"),
          maxsize: 10485760, // 10MB
          maxFiles: 10,
          format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json()
          ),
        })
      );
    }

    return winston.createLogger({
      level: this.logLevel,
      format: winston.format.combine(
        winston.format.errors({ stack: true }),
        winston.format.splat(),
        winston.format.json()
      ),
      transports,
      exitOnError: false,
    });
  }

  /**
   * Chalk ì»¬ëŸ¬ í…Œë§ˆ ì„¤ì •
   */
  setupColorTheme() {
    this.colors = {
      error: chalk.bold.red,
      warn: chalk.bold.yellow,
      info: chalk.bold.cyan,
      debug: chalk.gray,
      success: chalk.bold.green,
      http: chalk.bold.magenta,
      verbose: chalk.white,
      silly: chalk.dim,

      // íŠ¹ìˆ˜ ìŠ¤íƒ€ì¼
      timestamp: chalk.dim.gray,
      module: chalk.bold.blue,
      user: chalk.bold.green,
      important: chalk.bold.bgRed.white,
      highlight: chalk.bold.bgYellow.black,
    };
  }

  /**
   * í•œêµ­ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
   */
  getKoreaTime() {
    const now = new Date();
    const koreaTime = new Date(
      now.getTime() + 9 * 60 * 60 * 1000 - now.getTimezoneOffset() * 60 * 1000
    );
    return koreaTime.toLocaleString("ko-KR", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
    });
  }

  /**
   * ì»¬ëŸ¬í’€í•œ ì½˜ì†” ì¶œë ¥ (Chalk í™œìš©)
   */
  _colorLog(level, message, ...args) {
    const emoji = this.emojis[level] || "ğŸ“";
    const color = this.colors[level] || chalk.white;
    const timestamp = this.colors.timestamp(this.getKoreaTime());

    // ë©”íƒ€ë°ì´í„° ì²˜ë¦¬
    let meta = "";
    if (args.length > 0) {
      if (typeof args[0] === "object") {
        meta = this.formatMetadata(args[0]);
      } else {
        meta = args.join(" ");
      }
    }

    // ì»¬ëŸ¬í’€í•œ ì¶œë ¥
    console.log(
      `${timestamp} ${emoji} ${color(
        level.toUpperCase().padEnd(7)
      )} ${message} ${meta}`
    );

    // Winstonì—ë„ ê¸°ë¡
    this.logger[level](message, ...args);
  }

  /**
   * ë©”íƒ€ë°ì´í„° í¬ë§·íŒ…
   */
  formatMetadata(obj) {
    const formatted = [];

    for (const [key, value] of Object.entries(obj)) {
      if (key === "userId") {
        formatted.push(`${chalk.gray("user:")}${this.colors.user(value)}`);
      } else if (key === "module") {
        formatted.push(`${chalk.gray("module:")}${this.colors.module(value)}`);
      } else if (key === "error") {
        formatted.push(`${chalk.gray("error:")}${chalk.red(value)}`);
      } else if (key === "duration") {
        formatted.push(
          `${chalk.gray("duration:")}${chalk.yellow(value + "ms")}`
        );
      } else {
        formatted.push(`${chalk.gray(key + ":")}${chalk.white(value)}`);
      }
    }

    return chalk.gray("[") + formatted.join(chalk.gray(", ")) + chalk.gray("]");
  }

  // ===== ğŸ¯ ë©”ì¸ ë¡œê¹… ë©”ì„œë“œë“¤ =====

  error(message, ...args) {
    this._colorLog("error", message, ...args);
  }

  warn(message, ...args) {
    this._colorLog("warn", message, ...args);
  }

  info(message, ...args) {
    this._colorLog("info", message, ...args);
  }

  debug(message, ...args) {
    if (this.logLevel === "debug") {
      this._colorLog("debug", message, ...args);
    }
  }

  success(message, ...args) {
    // Winstonì—ëŠ” success ë ˆë²¨ì´ ì—†ìœ¼ë¯€ë¡œ infoë¡œ ê¸°ë¡
    const emoji = this.emojis.success;
    const color = this.colors.success;
    const timestamp = this.colors.timestamp(this.getKoreaTime());

    console.log(
      `${timestamp} ${emoji} ${color("SUCCESS".padEnd(7))} ${message}`,
      args.length > 0 ? this.formatMetadata(args[0]) : ""
    );

    this.logger.info(`[SUCCESS] ${message}`, ...args);
  }

  // ===== ğŸ¨ íŠ¹ìˆ˜ ë¡œê¹… ë©”ì„œë“œë“¤ =====

  /**
   * ëª¨ë“ˆ ì‹œì‘ ë¡œê·¸
   */
  moduleStart(moduleName) {
    const box = chalk.bold.blue("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
    const text =
      chalk.bold.blue("â”‚") +
      chalk.bold.white(` ğŸš€ ${moduleName} ì‹œì‘ `.padEnd(28)) +
      chalk.bold.blue("â”‚");
    const bottom = chalk.bold.blue("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");

    console.log(`\n${box}\n${text}\n${bottom}\n`);
    this.logger.info(`Module started: ${moduleName}`);
  }

  /**
   * ì¤‘ìš” ì•Œë¦¼
   */
  important(message, ...args) {
    const importantBox = this.colors.important(` âš¡ ${message} `);
    console.log(`\n${importantBox}\n`);
    this.logger.warn(`[IMPORTANT] ${message}`, ...args);
  }

  /**
   * í•˜ì´ë¼ì´íŠ¸
   */
  highlight(message, ...args) {
    const highlighted = this.colors.highlight(` ğŸ’¡ ${message} `);
    console.log(highlighted);
    this.logger.info(`[HIGHLIGHT] ${message}`, ...args);
  }

  /**
   * í…Œì´ë¸” ì¶œë ¥
   */
  table(data) {
    console.table(data);
    this.logger.info("Table data:", data);
  }

  /**
   * ì§„í–‰ ìƒí™© í‘œì‹œ
   */
  progress(current, total, message = "") {
    const percentage = Math.round((current / total) * 100);
    const filled = Math.round(percentage / 5);
    const empty = 20 - filled;

    const bar = chalk.green("â–ˆ".repeat(filled)) + chalk.gray("â–‘".repeat(empty));
    const text = `${bar} ${chalk.bold(percentage + "%")} ${message}`;

    process.stdout.write(`\r${text}`);

    if (current === total) {
      console.log(""); // ì¤„ë°”ê¿ˆ
      this.success(`ì™„ë£Œ: ${message}`);
    }
  }

  // ===== ğŸ“Š í†µê³„ ë° ìœ í‹¸ë¦¬í‹° =====

  /**
   * ë¡œê·¸ ë ˆë²¨ ë³€ê²½
   */
  setLevel(level) {
    this.logLevel = level;
    this.logger.level = level;
    this.info(`ë¡œê·¸ ë ˆë²¨ ë³€ê²½: ${level}`);
  }

  /**
   * ì„±ëŠ¥ ì¸¡ì • ë¡œê·¸
   */
  performance(label, startTime) {
    const duration = Date.now() - startTime;
    const color =
      duration < 100 ? chalk.green : duration < 500 ? chalk.yellow : chalk.red;

    this.debug(`â±ï¸  ${label}`, { duration: color(duration + "ms") });
  }

  /**
   * ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¡œê·¸
   */
  memory() {
    const used = process.memoryUsage();
    const format = (bytes) => (bytes / 1024 / 1024).toFixed(2) + " MB";

    this.debug("ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰", {
      rss: format(used.rss),
      heapTotal: format(used.heapTotal),
      heapUsed: format(used.heapUsed),
      external: format(used.external),
    });
  }

  /**
   * ìƒíƒœ ì¡°íšŒ
   */
  getStatus() {
    return {
      initialized: true,
      level: this.logLevel,
      isProduction: this.isProduction,
      isRailway: this.isRailway,
      transports: this.logger.transports.length,
      logDirectory: this.isRailway ? "disabled" : this.logDir,
    };
  }
}

// ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ë‚´ë³´ë‚´ê¸°
const logger = new AdvancedLogger();

// ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ì„±ì„ ìœ„í•œ ë©”ì„œë“œë“¤
logger.trace = logger.debug;
logger.logTimeInfo = () => logger.info("ğŸ• ì‹œê°„ ì •ë³´ ë¡œë”© ì™„ë£Œ");

module.exports = logger;

// ===== ì‚¬ìš© ì˜ˆì‹œ =====
/*
// ê¸°ë³¸ ë¡œê¹…
logger.info("ì„œë²„ ì‹œì‘ë¨");
logger.error("ì˜¤ë¥˜ ë°œìƒ", { error: "Database connection failed" });
logger.warn("ê²½ê³ ", { userId: 12345, action: "invalidLogin" });
logger.success("ì‘ì—… ì™„ë£Œ");

// íŠ¹ìˆ˜ ë¡œê¹…
logger.moduleStart("TodoModule");
logger.important("ê¸´ê¸‰ ê³µì§€ì‚¬í•­");
logger.highlight("ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€");

// í…Œì´ë¸” ì¶œë ¥
logger.table([
  { module: "Todo", status: "active", users: 150 },
  { module: "Timer", status: "active", users: 89 }
]);

// ì§„í–‰ ìƒí™©
for (let i = 0; i <= 100; i += 10) {
  logger.progress(i, 100, "ë°ì´í„° ì²˜ë¦¬ ì¤‘...");
  await new Promise(resolve => setTimeout(resolve, 100));
}

// ì„±ëŠ¥ ì¸¡ì •
const start = Date.now();
// ... ì‘ì—… ìˆ˜í–‰ ...
logger.performance("DB Query", start);

// ë©”ëª¨ë¦¬ ì²´í¬
logger.memory();
*/
